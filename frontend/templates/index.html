<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Mastering Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .slider-track { background: #334155; }
        .slider-thumb { background: #38bdf8; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; background: #38bdf8; margin-top: -6px; }
        input[type=range]::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; background: #38bdf8; }
        .loader { border-top-color: #38bdf8; }
    </style>
</head>
<body class="h-full flex items-center justify-center p-4 bg-slate-900 text-slate-300">

    <div class="w-full max-w-4xl mx-auto">
        <div class="text-center mb-8">
            <!-- FIX: Restored the main H1 title -->
            <h1 class="text-4xl font-bold text-white tracking-tight">Audio Mastering Suite</h1>
            <p class="mt-2 text-lg text-slate-400">Upload your track, define your sound, and let our AI-powered engine do the rest.</p>
        </div>

        <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-2xl p-6 md:p-8 shadow-2xl">
            <form id="mastering-form">
                <div class="mb-6">
                    <label for="file-input" class="block text-sm font-medium text-slate-300 mb-2">Input Audio File</label>
                    <div class="flex items-center justify-between p-3 bg-slate-900/50 rounded-lg border border-slate-700">
                        <span id="file-name" class="text-slate-400 italic truncate pr-4">No file selected</span>
                        <input type="file" id="file-input" class="hidden" accept="audio/*">
                        <button type="button" id="browse-button" class="px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white font-semibold rounded-md transition-colors duration-200 whitespace-nowrap">Browse</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mb-6">
                    <!-- Sliders will be dynamically generated here by JavaScript -->
                </div>

                <div class="space-y-4 mb-8">
                    <div class="flex items-center">
                        <input id="multiband-checkbox" name="multiband" type="checkbox" class="h-4 w-4 rounded border-slate-600 bg-slate-800 text-sky-500 focus:ring-sky-600">
                        <label for="multiband-checkbox" class="ml-3 block text-sm font-medium text-slate-300">Use Multiband Compressor</label>
                    </div>
                    <div class="flex items-center">
                        <input id="auto-art-checkbox" name="auto_generate_prompt" type="checkbox" checked class="h-4 w-4 rounded border-slate-600 bg-slate-800 text-sky-500 focus:ring-sky-600">
                        <label for="auto-art-checkbox" class="ml-3 block text-sm font-medium text-slate-300">Auto-generate art prompt from audio analysis?</label>
                    </div>
                    <div class="flex items-center">
                        <input id="create-mp3-checkbox" name="create_mp3" type="checkbox" checked class="h-4 w-4 rounded border-slate-600 bg-slate-800 text-sky-500 focus:ring-sky-600">
                        <label for="create-mp3-checkbox" class="ml-3 block text-sm font-medium text-slate-300">Also create high-quality MP3 for listening?</label>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label for="art-prompt" class="block text-sm font-medium text-slate-300">Manual AI Art Prompt (Optional)</label>
                    <input type="text" name="art_prompt" id="art-prompt" class="mt-1 block w-full bg-slate-900/50 border border-slate-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., A vibrant explosion of color, digital art">
                </div>

                <button type="submit" id="submit-button" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center">
                    <span id="submit-button-text">Upload & Process</span>
                    <div id="submit-loader" class="hidden loader ease-linear rounded-full border-4 border-t-4 border-slate-400 h-6 w-6"></div>
                </button>
            </form>
            <div id="status-container" class="mt-6 text-center p-4 bg-slate-900/50 rounded-lg border border-slate-700" style="display: none;">
                <p id="status-message" class="text-sky-400 font-medium"></p>
                <div class="w-full bg-slate-700 rounded-full h-2.5 mt-2">
                    <div id="progress-bar" class="bg-sky-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                 <p id="studio-notes" class="text-xs text-slate-400 mt-2 italic"></p>
                <div id="results-container" class="mt-4" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const form = document.getElementById('mastering-form');
            const fileInput = document.getElementById('file-input');
            const browseButton = document.getElementById('browse-button');
            const fileNameDisplay = document.getElementById('file-name');
            const multibandCheckbox = document.getElementById('multiband-checkbox');
            const sliderGrid = document.querySelector('.grid');
            const submitButton = document.getElementById('submit-button');
            const submitButtonText = document.getElementById('submit-button-text');
            const submitLoader = document.getElementById('submit-loader');
            const statusContainer = document.getElementById('status-container');
            const statusMessage = document.getElementById('status-message');
            const progressBar = document.getElementById('progress-bar');
            
            // FIX: Sliders now default to neutral values (0 or 1 for width).
            const sliders = [
                { id: 'analog_character', name: 'Analog Character (%)', min: 0, max: 100, step: 1, value: 0 },
                { id: 'bass_boost', name: 'Bass (dB)', min: -6, max: 6, step: 0.5, value: 0 },
                { id: 'mid_cut', name: 'Mid Cut (dB)', min: 0, max: 6, step: 0.5, value: 0 },
                { id: 'presence_boost', name: 'Presence (dB)', min: 0, max: 6, step: 0.5, value: 0 },
                { id: 'treble_boost', name: 'Treble (dB)', min: -6, max: 6, step: 0.5, value: 0 },
                { id: 'width', name: 'Stereo Width', min: 0, max: 2, step: 0.1, value: 1 },
                { id: 'lufs', name: 'Target LUFS', min: -20, max: -6, step: 0.5, value: -14 },
            ];

            const multibandSliders = [
                { id: 'low_thresh', name: 'Low Thresh (dB)', min: -40, max: 0, step: 1, value: -20 },
                { id: 'mid_thresh', name: 'Mid Thresh (dB)', min: -40, max: 0, step: 1, value: -20 },
                { id: 'high_thresh', name: 'High Thresh (dB)', min: -40, max: 0, step: 1, value: -20 },
                { id: 'low_ratio', name: 'Low Ratio', min: 1, max: 10, step: 0.5, value: 4 },
                { id: 'mid_ratio', name: 'Mid Ratio', min: 1, max: 10, step: 0.5, value: 4 },
                { id: 'high_ratio', name: 'High Ratio', min: 1, max: 10, step: 0.5, value: 4 },
            ];
            
            const createSlider = (slider) => {
                const container = document.createElement('div');
                container.id = `container-${slider.id}`;
                container.innerHTML = `
                    <label for="${slider.id}" class="flex justify-between text-sm font-medium text-slate-300">
                        <span>${slider.name}</span>
                        <span id="value-${slider.id}">${slider.value}</span>
                    </label>
                    <input type="range" id="${slider.id}" name="${slider.id}" min="${slider.min}" max="${slider.max}" value="${slider.value}" step="${slider.step}" class="w-full h-2 rounded-lg appearance-none cursor-pointer slider-track">
                `;
                const input = container.querySelector('input');
                const valueDisplay = container.querySelector(`#value-${slider.id}`);
                input.addEventListener('input', () => valueDisplay.textContent = input.value);
                return container;
            };

            const renderSliders = () => {
                sliderGrid.innerHTML = '';
                sliders.forEach(s => sliderGrid.appendChild(createSlider(s)));
                if (multibandCheckbox.checked) {
                    multibandSliders.forEach(s => sliderGrid.appendChild(createSlider(s)));
                }
            };
            
            browseButton.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    fileNameDisplay.textContent = fileInput.files[0].name;
                    fileNameDisplay.classList.remove('italic');
                } else {
                    fileNameDisplay.textContent = 'No file selected';
                    fileNameDisplay.classList.add('italic');
                }
            });

            multibandCheckbox.addEventListener('change', renderSliders);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (fileInput.files.length === 0) {
                    // Changed from alert() to a status message for better UX
                    updateStatus('Please select an audio file first.', 0, true);
                    return;
                }
                
                setLoading(true);
                updateStatus('Requesting secure upload policy...', 0);
                
                const file = fileInput.files[0];
                const filename = file.name;
                const contentType = file.type;

                try {
                    // --- FIX: Logic updated for Signed Policy Documents ---
                    // 1. Get Signed Policy Document from our backend
                    const policyResponse = await fetch('/generate-upload-url', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename, contentType })
                    });

                    if (!policyResponse.ok) {
                        const errorBody = await policyResponse.json();
                        throw new Error(errorBody.error || 'Could not get upload policy.');
                    }
                    const { url, fields, gcsUri } = await policyResponse.json();
                    
                    // 2. Upload file directly to GCS using a POST request with the policy fields
                    updateStatus('Uploading audio file...', 5);
                    const uploadFormData = new FormData();
                    for (const key in fields) {
                        uploadFormData.append(key, fields[key]);
                    }
                    uploadFormData.append('file', file);
                    
                    const uploadResponse = await fetch(url, {
                        method: 'POST',
                        body: uploadFormData
                    });
                    
                    if (!uploadResponse.ok) throw new Error('File upload to GCS failed.');
                    // --- END FIX ---

                    // 3. Submit the job to our backend
                    updateStatus('Submitting mastering job...', 10);
                    const settingsData = new FormData(form);
                    const settings = {};
                    for (const [key, value] of settingsData.entries()) {
                        settings[key] = isNaN(value) ? value : Number(value);
                    }
                    settings.original_filename = filename;
                    
                    const jobResponse = await fetch('/submit-job', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ gcs_uri: gcsUri, settings })
                    });
                    
                    if (!jobResponse.ok) throw new Error('Job submission failed.');
                    const { job_id } = await jobResponse.json();

                    pollJobStatus(job_id);

                } catch (error) {
                    console.error('Submission error:', error);
                    updateStatus(`Error: ${error.message}`, 0, true);
                    setLoading(false);
                }
            });
            
            const setLoading = (isLoading) => {
                submitButton.disabled = isLoading;
                submitButtonText.classList.toggle('hidden', isLoading);
                submitLoader.classList.toggle('hidden', !isLoading);
            };

            const updateStatus = (message, progress, isError = false) => {
                statusContainer.style.display = 'block';
                statusMessage.textContent = message;
                statusMessage.className = isError ? 'text-red-400 font-medium' : 'text-sky-400 font-medium';
                progressBar.style.width = `${progress}%`;
            };
            
            const pollJobStatus = (jobId) => {
                console.log("Job submitted, listening for updates on job:", jobId);
                updateStatus('Job submitted! The worker is processing your track...', 25);
            };

            renderSliders();
        });
    </script>
</body>
</html>

